var A=Object.create;var p=Object.defineProperty;var O=Object.getOwnPropertyDescriptor;var M=Object.getOwnPropertyNames;var F=Object.getPrototypeOf,R=Object.prototype.hasOwnProperty;var v=(e,t)=>{for(var r in t)p(e,r,{get:t[r],enumerable:!0})},q=(e,t,r,i)=>{if(t&&typeof t=="object"||typeof t=="function")for(let n of M(t))!R.call(e,n)&&n!==r&&p(e,n,{get:()=>t[n],enumerable:!(i=O(t,n))||i.enumerable});return e};var x=(e,t,r)=>(r=e!=null?A(F(e)):{},q(t||!e||!e.__esModule?p(r,"default",{value:e,enumerable:!0}):r,e)),B=e=>q(p({},"__esModule",{value:!0}),e);var N={};v(N,{enqueue:()=>X,getDb:()=>_,startWriters:()=>P,workerCount:()=>G});module.exports=B(N);var y=x(require("os")),E=require("worker_threads"),D=require("fs-extra"),W=require("shelljs"),l=[],h=y.cpus(),m=h.length,J=/CREATE TABLE IF NOT EXISTS ([^\s]+) \(/,d=[],g=0,w=!1,b=0;async function L(e,t,r){return new Promise(i=>{function n(u,c){let o=new E.Worker(e),s=null;function a(){!s&&l.length&&(b+=1,s=l.shift(),o.postMessage(s.message))}o.on("online",()=>{d.push({takeWork:a,shutdown:()=>o.terminate()}),a()}).on("message",async f=>{if(f===!0){if(b-=1,l.length===0&&b===0&&r()===!0)return i(!0)}else{if(s===null)return;s.resolve(f),s=null,a()}}).on("error",f=>{console.error(f)}),t(o,c)}h.forEach(n)})}var C=async e=>new Promise((t,r)=>{l.push({resolve:t,reject:r,message:e});let i=0;for(let n of d){if(i===g){n.takeWork(),g=(g+1)%m;break}i+=1}}),S=async(e,t,r,i,n=!1)=>((0,D.ensureDirSync)(e),L(__dirname+"/../dist/insert.js",(u,c)=>{u.postMessage({type:"connect",path:e+"/"+t+"."+c+".sqlite",transactions:i.toString()||"function (sql) { return sql }"}),u.postMessage({sql:r})},()=>{if(l.length>0||n===!1||w)return!1;w=!0,d.forEach(o=>o.shutdown());let u=e+"/"+t+".sqlite",c=[`(rm -f "${u}" && touch "${u}")`];for(let o=0;o<m;o++){let s=e+"/"+t+"."+o+".sqlite",a=r.match(J)[1];c.push(`(sqlite3 "${s}" ".dump ${a}" | sed -e 's/CREATE TABLE ${a} /CREATE TABLE IF NOT EXISTS ${a} /' | sqlite3 "${u}")`),c.push(`(rm -f "${s}" && rm -f "${s}-journal")`)}return(0,W.exec)(`((${c.join(" && ")}) & wait)`),!0}));var T=x(require("better-sqlite3"));var $=require("fs-extra"),k={},j=e=>(k[e]===void 0&&((0,$.ensureFileSync)(e),k[e]=new T.default(e,{verbose:console.log})),k[e]),I=async e=>C({type:"collection",data:e});var P=S,X=I,_=j,G=m;0&&(module.exports={enqueue,getDb,startWriters,workerCount});
//# sourceMappingURL=index.js.map